<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .input-field {
            display: block;
            width: 100%;
            border-radius: 0.375rem;
            border-width: 1px;
            border-color: #cbd5e1;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .input-field:focus {
            border-color: #3b82f6;
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #3b82f6;
            box-shadow: 0 0 0 2px var(--tw-ring-color);
        }

        .label-text {
            display: block;
            /* text-xs is 0.75rem, font-medium, text-slate-500, mb-0.5 is 0.125rem */
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            margin-bottom: 0.125rem;
        }

        .button-primary {
            background-color: #2563eb;
            color: white;
            font-weight: 600;
            /*semibold*/
            padding-top: 0.625rem;
            /* py-2.5 */
            padding-bottom: 0.625rem;
            padding-left: 1rem;
            /* px-4 */
            padding-right: 1rem;
            border-radius: 0.375rem;
            /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            /* shadow-sm */
            transition: background-color 0.15s ease-in-out;
        }

        .button-primary:hover {
            background-color: #1d4ed8;
        }

        .info-banner {
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-top: 1rem;
        }

        .info-banner-error {
            background-color: #fee2e2;
            border: 1px solid #fecaca;
            color: #b91c1c;
        }

        .info-banner-success {
            background-color: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .hidden {
            display: none;
        }

        /* Utility class */
    </style>
</head>

<body class="bg-slate-100 text-slate-800 antialiased">
    <div class="container mx-auto p-4 md:p-8 max-w-2xl">
        <header class="mb-8">
            <a href="/" class="text-blue-600 hover:text-blue-800">&larr; Back to Main App</a>
            <h1 class="text-3xl font-bold text-slate-700 mt-2">Application Settings</h1>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div id="settings-message" class="info-banner hidden"></div>

            <form id="settings-form">
                <div class="space-y-4">
                    <div>
                        <label for="app_scheme" class="label-text">Application Scheme (http or https):</label>
                        <select id="app_scheme" class="input-field">
                            <option value="http">http</option>
                            <option value="https">https</option>
                        </select>
                    </div>
                    <div>
                        <label for="app_hostname" class="label-text">Application Hostname (or IP Address, e.g.,
                            your-ngrok-id.ngrok-free.app):</label>
                        <input type="text" id="app_hostname" class="input-field"
                            placeholder="e.g., bfa3-172-250-227-47.ngrok-free.app or 123.45.67.89">
                        <p class="text-xs text-slate-500 mt-1">
                            Used for constructing the eBay Redirect URI and the Application Base URL.
                            <strong>Important:</strong> If this changes (e.g., new ngrok URL), you MUST update the
                            Redirect URI in your eBay
                            Developer Account settings first to match what will be constructed here.
                        </p>
                    </div>
                    <div>
                        <label for="app_port" class="label-text">Application Port (e.g., 5000):</label>
                        <input type="text" id="app_port" class="input-field"
                            placeholder="e.g., 5000 (leave empty for default 80/443)">
                        <p class="text-xs text-slate-500 mt-1">
                            Port your Flask application is running on. Leave empty if using standard ports (80 for http,
                            443 for https) and your ngrok/proxy handles port mapping.
                        </p>
                    </div>
                    <div>
                        <label for="ebay_redirect_uri_path" class="label-text">eBay Redirect URI Path (usually
                            fixed):</label>
                        <input type="text" id="ebay_redirect_uri_path" class="input-field" readonly>
                        <p class="text-xs text-slate-500 mt-1">
                            This is typically fixed to `/ebay-callback`. Do not change unless you have a specific
                            reason.
                        </p>
                    </div>
                    <hr />
                    <div>
                        <p class="label-text">Constructed Application Base URL (for image links, etc.):</p>
                        <p id="constructed_app_base_url"
                            class="text-sm text-slate-700 bg-slate-50 p-2 rounded border break-all">
                        </p>
                    </div>
                    <div>
                        <p class="label-text">Constructed eBay Redirect URI (must match eBay Developer Portal):</p>
                        <p id="constructed_ebay_redirect_uri"
                            class="text-sm text-slate-700 bg-slate-50 p-2 rounded border break-all"></p>
                    </div>
                </div>

                <div class="mt-6">
                    <button type="submit" class="button-primary w-full">Save Settings</button>
                </div>
            </form>
            <p class="text-xs text-slate-600 mt-4">
                <strong>Note:</strong> After saving, the application will use these settings to construct the eBay
                Redirect URI for new OAuth attempts.
                The "App Base URL" will be used by the frontend when generating image links for eBay listings.
                Always ensure the "Constructed eBay Redirect URI" shown above **exactly matches** what you have
                configured in your eBay Developer application settings.
            </p>
        </div>
    </div>

    <script>
        const settingsForm = document.getElementById('settings-form');
        const appSchemeInput = document.getElementById('app_scheme');
        const appHostnameInput = document.getElementById('app_hostname');
        const appPortInput = document.getElementById('app_port');
        const ebayRedirectUriPathInput = document.getElementById('ebay_redirect_uri_path');
        const constructedAppBaseUrlEl = document.getElementById('constructed_app_base_url');
        const constructedEbayRedirectUriEl = document.getElementById('constructed_ebay_redirect_uri');
        const settingsMessageEl = document.getElementById('settings-message');

        function showSettingsMessage(message, type = 'success') {
            settingsMessageEl.textContent = message;
            settingsMessageEl.className = 'info-banner'; // Reset
            if (type === 'success') settingsMessageEl.classList.add('info-banner-success');
            else settingsMessageEl.classList.add('info-banner-error');
            settingsMessageEl.classList.remove('hidden');
        }

        function hideSettingsMessage() {
            settingsMessageEl.classList.add('hidden');
            settingsMessageEl.textContent = '';
        }

        function updateConstructedUrls() {
            const scheme = appSchemeInput.value.trim() || 'http';
            const host = appHostnameInput.value.trim() || 'localhost';
            const port = appPortInput.value.trim();
            const path = ebayRedirectUriPathInput.value.trim() || '/ebay-callback';

            let baseUrl = `${scheme}://${host}`;
            // Only add port if it's not standard for the scheme
            if (port && !((scheme === 'http' && port === '80') || (scheme === 'https' && port === '443'))) {
                baseUrl += `:${port}`;
            }

            constructedAppBaseUrlEl.textContent = baseUrl;
            constructedEbayRedirectUriEl.textContent = `${baseUrl}${path}`;
        }

        async function loadCurrentSettings() {
            hideSettingsMessage();
            try {
                const response = await fetch('/api/get-settings');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.success && data.settings) {
                    appSchemeInput.value = data.settings.app_scheme || 'http';
                    appHostnameInput.value = data.settings.app_hostname || 'localhost';
                    appPortInput.value = data.settings.app_port || '5000';
                    ebayRedirectUriPathInput.value = data.settings.ebay_redirect_uri_path || '/ebay-callback';
                    updateConstructedUrls(); // Update display based on loaded settings
                } else {
                    showSettingsMessage(data.message || 'Failed to load settings.', 'error');
                }
            } catch (error) {
                console.error('Error fetching settings:', error);
                showSettingsMessage(`Error fetching settings: ${error.message}`, 'error');
            }
        }

        settingsForm.addEventListener('submit', async function (event) {
            event.preventDefault();
            hideSettingsMessage();
            const settingsData = {
                app_scheme: appSchemeInput.value.trim(),
                app_hostname: appHostnameInput.value.trim(),
                app_port: appPortInput.value.trim(),
                ebay_redirect_uri_path: ebayRedirectUriPathInput.value.trim() // Path should be non-empty
            };

            // Basic client-side validation
            if (!settingsData.app_hostname) {
                showSettingsMessage('Application Hostname cannot be empty.', 'error');
                return;
            }
            if (!settingsData.ebay_redirect_uri_path || !settingsData.ebay_redirect_uri_path.startsWith('/')) {
                showSettingsMessage('eBay Redirect URI Path must start with a forward slash (e.g., /ebay-callback).', 'error');
                return;
            }


            try {
                const response = await fetch('/api/update-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });
                const result = await response.json();
                if (result.success) {
                    showSettingsMessage(result.message || 'Settings saved successfully!', 'success');
                    // Reload settings to reflect changes and update constructed URLs display
                    loadCurrentSettings();
                } else {
                    showSettingsMessage(result.message || 'Failed to save settings.', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showSettingsMessage(`Error saving settings: ${error.message}`, 'error');
            }
        });

        // Add event listeners to update constructed URLs dynamically on input change
        [appSchemeInput, appHostnameInput, appPortInput, ebayRedirectUriPathInput].forEach(inputEl => {
            inputEl.addEventListener('input', updateConstructedUrls); // For text inputs
            inputEl.addEventListener('change', updateConstructedUrls); // For select
        });

        document.addEventListener('DOMContentLoaded', loadCurrentSettings);
    </script>
</body>

</html>